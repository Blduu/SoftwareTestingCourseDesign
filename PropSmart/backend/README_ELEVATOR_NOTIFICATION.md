# PropSmart电梯通知系统设计文档

## 概述
电梯通知系统是PropSmart物业管理平台的重要组成部分，负责向不同角色的用户实时推送电梯相关的状态变化、异常情况和维护信息。通知系统采用层级化设计，根据电梯状态和异常的严重程度，分别向不同角色的用户发送针对性通知。

## 通知对象类型
系统支持以下几类通知对象：
1. **管理员通知**：物业管理员和维护人员接收所有电梯状态变化和异常情况的通知
2. **楼栋用户通知**：该楼栋所有用户接收电梯运行状态变化的通知
3. **业主专项通知**：根据房产所有者身份证（ownerIdentity）向特定业主发送相关通知

## 通知分级机制
系统根据电梯异常的严重程度将通知分为不同级别：

### 管理员通知分级
1. **严重异常通知**（紧急）
   - 触发条件：电梯出现严重故障（SERIOUS级别异常）
   - 表现形式：高优先级提醒，需要立即处理
   - 通知内容：详细的异常信息、电梯位置、异常类型和描述

2. **中等异常通知**（警告）
   - 触发条件：电梯出现中等级别异常（MODERATE级别异常）
   - 表现形式：中优先级提醒，需要尽快关注
   - 通知内容：异常信息、电梯位置和运行状态

3. **轻微异常通知**（提示）
   - 触发条件：电梯出现轻微异常（MINOR级别异常）
   - 表现形式：低优先级提醒，需要定期检查
   - 通知内容：简要异常信息

4. **维护完成通知**
   - 触发条件：电梯维护工作完成
   - 表现形式：普通通知
   - 通知内容：维护记录、解决的问题数量

### 用户通知分级
1. **故障通知**（紧急）
   - 触发条件：电梯发生严重故障，无法使用
   - 表现形式：高优先级提醒
   - 通知内容：简明的故障提示，建议使用其他电梯或楼梯

2. **异常提醒**（普通）
   - 触发条件：电梯出现异常，但仍可使用
   - 表现形式：普通提醒
   - 通知内容：简短提示，建议谨慎使用

3. **维护通知**（普通）
   - 触发条件：电梯进入维护状态
   - 表现形式：普通提醒
   - 通知内容：维护时间和使用建议

4. **恢复通知**（普通）
   - 触发条件：电梯恢复正常运行
   - 表现形式：普通提醒
   - 通知内容：恢复正常使用的提示

## 通知触发场景
系统会在以下场景自动触发通知：

1. **电梯状态变化**
   - 正常->故障：通知管理员和楼栋用户
   - 正常->维护：通知楼栋用户
   - 故障/维护->正常：通知楼栋用户和管理员

2. **电梯异常检测**
   - 检测到新异常：根据级别通知管理员
   - 严重异常：额外通知楼栋所有用户和业主

3. **电梯维护活动**
   - 维护开始：通知楼栋用户
   - 维护完成：通知楼栋用户和管理员

4. **定期状态更新**
   - 长时间未修复的异常：定期提醒管理员

## 技术实现
系统采用WebSocket实时推送技术，实现以下核心功能：

1. **消息分发**
   - `sendMessageToUser`: 发送消息给特定用户
   - `sendMessageToAllAdmins`: 发送消息给所有管理员
   - `sendMessageToBuildingUsers`: 发送消息给特定楼栋的所有用户

2. **状态监控**
   - 通过ElevatorDataSimulatorJob实时监控电梯状态变化
   - 检测温度、速度、功耗等参数异常

3. **异常级别判定**
   - 根据异常类型和数值判定严重程度
   - 自动分级并触发相应通知

4. **业主定向通知**
   - 根据房产信息及ownerIdentity查找对应业主
   - 发送针对性通知

## 业务流程示例

### 电梯故障流程
1. 系统检测到电梯X出现电机过热严重故障
2. 更新电梯状态为FAULT
3. 创建SERIOUS级别的异常记录
4. 向所有管理员发送紧急通知，包含详细故障信息
5. 向楼栋用户发送故障通知，告知暂停使用
6. 向业主发送特别通知，包含详细房产信息

### 电梯维护流程
1. 管理员对电梯X执行维护操作
2. 更新电梯状态为MAINTENANCE
3. 向楼栋用户发送维护通知
4. 维护完成后，更新电梯状态为NORMAL
5. 向管理员发送维护完成报告，包含已解决问题
6. 向楼栋用户发送恢复使用通知

## 系统配置
通知系统可根据物业需求进行配置：

- 可自定义哪些类型的中等异常需要通知用户
- 可配置是否启用业主专项通知
- 可设置通知的持久化存储规则

## 总结
PropSmart电梯通知系统通过分级推送机制，确保不同角色的用户能及时获取与其相关的电梯信息，提高了物业管理的效率和用户体验，同时为电梯安全运行提供了有力保障。 